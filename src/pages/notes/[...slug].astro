---

import { getCollection } from "astro:content";
import Markdown from "../../components/misc/Markdown.astro";
import { profileConfig, siteConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import MainGridLayout from "../../layouts/MainGridLayout.astro";
import { formatDate, formatDateToYYYYMMDD } from "../../utils/date-utils";

// 获取所有随记并生成静态路径
export async function getStaticPaths() {
	const notes = await getCollection("notes");
	// 严格过滤有效且非草稿的note
	const validNotes = notes.filter((note) => {
		return (
			note &&
			typeof note === "object" &&
			note.data &&
			typeof note.data === "object" &&
			!note.data.draft
		);
	});
	return validNotes.map((note) => ({
		params: { slug: note.slug },
		props: { note },
	}));
}

// 获取当前随记数据
const { note } = Astro.props;
const { Content, headings } = await note.render();

// 生成结构化数据
const jsonLd = {
	"@context": "https://schema.org",
	"@type": "NoteDigitalDocument",
	headline: note.data.title || "随记",
	description: "随记内容",
	author: {
		"@type": "Person",
		name: profileConfig.name,
		url: Astro.site,
	},
	datePublished: formatDateToYYYYMMDD(note.data.published),
	inLanguage: note.data.lang
		? note.data.lang.replace("_", "-")
		: siteConfig.lang.replace("_", "-"),
};
---

<MainGridLayout title={note.data.title || "随记"} description="随记内容" lang={note.data.lang} setOGTypeArticle={true} headings={headings}>
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
    
    <div class="flex flex-col items-center w-full py-6">
        <!-- 硬卡样式随记 -->
        <div id="note-container" class="w-full max-w-2xl overflow-hidden shadow-md hover:shadow-lg hover:shadow-gray-300/20 transition-all duration-300 border border-white/20 bg-gray-200 bg-opacity-10 text-white">
            <!-- 卡片主体 -->
            <div class="p-5">
                <!-- 随记图片 -->
                {note.data.image && (
                    <div class="note-image w-full mb-4 overflow-hidden rounded-md">
                        <img 
                            src={note.data.image} 
                            alt="Note image" 
                            class="w-full h-auto max-h-64 object-contain transition-transform duration-500 hover:scale-102"
                        />
                    </div>
                )}
                
                <!-- 随记头部 -->
                <div class="note-header mb-4">
                    <!-- 日期 -->
                    <div class="text-xs text-white/80 font-mono mb-4 border-b border-white/10 pb-2">
                        {formatDate(note.data.published)}
                    </div>
                    
                    <!-- 标题 -->
                    {note.data.title && (
                        <h1 class="text-xl md:text-2xl font-medium text-white font-['SimSun',serif]">
                            {note.data.title}
                        </h1>
                    )}
                </div>

                <!-- 随记内容 -->
                <div class="note-content whitespace-pre-wrap">
                    <Markdown class="markdown-content prose prose-white max-w-none">
                        <Content />
                    </Markdown>
                </div>
            </div>
        </div>

        <!-- 返回随记列表 -->
        <div class="mt-6">
            <a 
                href="/notes/"
                class="inline-flex items-center gap-2 px-5 py-2 rounded-md font-medium transition-all duration-300 bg-[var(--btn-regular-bg)] hover:bg-[var(--btn-regular-bg-hover)] border border-white/30 text-white hover:shadow-md hover:-translate-y-1"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                {i18n(I18nKey.back_to_notes)}
            </a>
        </div>
    </div>

    <style>
        /* 随记内容样式 */
        .note-content {
            overflow: auto;
            max-height: calc(100vh - 400px);
            line-height: 1.8;
        }
        
        /* Markdown 内容美化 */
        .markdown-content {
            color: white;
        }
        
        .markdown-content p {
            margin-bottom: 0.875rem;
        }
        
        /* 图片样式优化 */
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            #note-container {
                margin: 0 1rem;
            }
            
            .note-content {
                max-height: calc(100vh - 350px);
            }
        }
        
        @media (max-width: 480px) {
            .note-header h1 {
                font-size: 1.5rem;
            }
            
            .note-content {
                max-height: calc(100vh - 300px);
            }
        }
    </style>
</MainGridLayout>