---
import { profileConfig, siteConfig } from "@/config";
import ConfigCarrier from "@components/ConfigCarrier.astro";
import {
	AUTO_MODE,
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { url, pathsEqual } from "../utils/url-utils";
import "katex/dist/katex.css";
import "photoswipe/style.css";
import BackToTop from "@components/control/BackToTop.astro";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
}

let { title, banner, description, lang, setOGTypeArticle } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;
if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = siteConfig.banner.src;
}

// TODO don't use post cover as banner for now
banner = siteConfig.banner.src;

const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = `${siteConfig.title} - ${siteConfig.subtitle}`;
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] transition text-[14px] md:text-[16px]"
	  data-overlayscrollbars-initialize
>
	<head>
		<!-- 性能优化：尽早设置字符集 -->
		<meta charset="UTF-8" />
		<!-- 性能优化：优化视口设置，减少布局偏移 -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
		<!-- 性能优化：设置主题色 -->
		<meta name="theme-color" content="#ff9800">
		<!-- 性能优化：减少DNS查找时间 -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
		<!-- 性能优化：预加载关键资源 -->
		<link rel="preload" href="/favicon/favicon-light-32.png" as="image">
		<!-- 性能优化：预加载主要字体 -->
		<link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" as="style">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
		<!-- 性能优化：移动端优化 -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="mobile-web-app-capable" content="yes">

		<title>{pageTitle}</title>
		<meta name="description" content={description || pageTitle}>
		<meta name="author" content={profileConfig.name}>
		<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
		<meta name="language" content={siteLang}>

		<!-- Open Graph Meta Tags -->
		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description || pageTitle}>
		<meta property="og:image" content={banner}>
		<meta property="og:image:alt" content={`${siteConfig.title} banner`}>
		<meta property="og:image:width" content="1200">
		<meta property="og:image:height" content="630">
		<meta property="og:locale" content={siteLang}>
		{setOGTypeArticle ? (
        <meta property="og:type" content="article" />
        ) : (
        <meta property="og:type" content="website" />
        )}

		<!-- Twitter Card Meta Tags -->
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:site" content="">
		<meta name="twitter:creator" content="">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description || pageTitle}>
		<meta name="twitter:image" content={banner}>
		<meta name="twitter:image:alt" content={`${siteConfig.title} banner`}>

		<!-- Canonical URL -->
		<link rel="canonical" href={Astro.url}>

		<!-- Structured Data (JSON-LD) -->
		<script is:inline type="application/ld+json">
		{
			"@context": "https://schema.org",
			"@type": "${setOGTypeArticle ? 'Article' : 'WebSite'}",
			"name": "${siteConfig.title}",
			"headline": "${title || siteConfig.title}",
			"description": "${description || siteConfig.description || pageTitle}",
			"url": "${Astro.url}",
			"image": "${banner}",
			"author": {
				"@type": "Person",
				"name": "${profileConfig.name}",
				"url": "${Astro.url}"
			},
			"publisher": {
				"@type": "Person",
				"name": "${profileConfig.name}",
				"logo": {
					"@type": "ImageObject",
					"url": "${favicons[0]?.src || ''}"
				}
			}${setOGTypeArticle ? `,
			"datePublished": "2024-01-01",
			"dateModified": "2024-01-01"` : ''}
		}
		</script>

		<meta name="generator" content={Astro.generator} />
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue}}>
			// Load the theme from local storage
			const theme = localStorage.getItem('theme') || DEFAULT_THEME;
			switch (theme) {
				case LIGHT_MODE:
					document.documentElement.classList.remove('dark');
					break;
				case DARK_MODE:
					document.documentElement.classList.add('dark');
					break;
				case AUTO_MODE:
					if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
						document.documentElement.classList.add('dark');
					} else {
						document.documentElement.classList.remove('dark');
					}
			}

			// Load the hue from local storage
			const hue = localStorage.getItem('hue') || configHue;
			document.documentElement.style.setProperty('--hue', hue);

			// Calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			const calculateBannerHeight = () => {
				let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
				offset = offset - offset % 4;
				document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
			};
			calculateBannerHeight();
		</script>
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
		}}></style>  <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->


		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>
	</head>
	<body class="min-h-screen transition" class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}
		  data-overlayscrollbars-initialize
		  <!-- 性能优化：减少不必要的触摸事件延迟 -->
		  style="touch-action: manipulation; -webkit-tap-highlight-color: transparent; -webkit-overflow-scrolling: touch;"
	>
		<ConfigCarrier></ConfigCarrier>
		<slot />
		<BackToTop />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>
	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
	
/* Swup 页面过渡动画 - 已禁用
	.transition-swup-fade {
		transition: opacity 0.25s ease-in-out;
	}
	.transition-swup-fade-enter {
		opacity: 0;
	}
	.transition-swup-fade-enter-active {
		opacity: 1;
	}
	.transition-swup-fade-exit {
		opacity: 1;
	}
	.transition-swup-fade-exit-active {
		opacity: 0;
	}
    */
}
</style>

<script defer is:inline>
// 兼容性检查和错误处理
const compatibilityChecks = {
	init: () => {
		// 检查必要的API支持
		compatibilityChecks.checkAPIs();
		
		// 检查浏览器特性支持
		compatibilityChecks.checkFeatures();
		
		// 初始化错误处理
		compatibilityChecks.initErrorHandling();
	},
	
	checkAPIs: () => {
		// 检查Performance API支持
		if (!('performance' in window)) {
			// 降级处理
			window.performance = {
				mark: () => {},
				measure: () => {},
				getEntriesByName: () => []
			};
		}
		
		// 检查requestIdleCallback支持
		if (!('requestIdleCallback' in window)) {
			window.requestIdleCallback = (callback) => {
				return setTimeout(callback, 100);
			};
			window.cancelIdleCallback = (id) => {
				clearTimeout(id);
			};
		}
		
		// 检查IntersectionObserver支持
		if (!('IntersectionObserver' in window)) {
			// 降级处理
			window.IntersectionObserver = class {
				constructor(callback) {
					this.callback = callback;
				}
				
				observe() {
					// 立即执行回调
					setTimeout(() => {
						this.callback([{ isIntersecting: true }], this);
					}, 100);
				}
				
				unobserve() {}
				disconnect() {}
			};
		}
	},
	
	checkFeatures: () => {
		// 检查CSS特性支持
		const checkCSSFeature = (property) => {
			return property in document.documentElement.style;
		};
		
		// 检查必要的CSS特性
		const cssFeatures = [
			'backdropFilter',
			'clipPath',
			'transform',
			'transition'
		];
		
		cssFeatures.forEach(feature => {
			if (!checkCSSFeature(feature)) {
				// 添加降级类
				document.documentElement.classList.add(`no-${feature}`);
			}
		});
	},
	
	initErrorHandling: () => {
		// 全局错误处理
		window.addEventListener('error', (e) => {
			// 忽略资源加载错误
			if (e.target instanceof Element) {
				return;
			}
			
			console.warn('Global error:', e.error);
		});
		
		// 未捕获的Promise错误处理
		window.addEventListener('unhandledrejection', (e) => {
			console.warn('Unhandled promise rejection:', e.reason);
		});
	}
};

// 初始化兼容性检查
compatibilityChecks.init();

// 延迟加载非关键CSS
const loadOverlayScrollbarsCSS = () => {
	const link = document.createElement('link');
	link.rel = 'stylesheet';
	link.href = 'https://cdn.jsdelivr.net/npm/overlayscrollbars@2.13.0/styles/overlayscrollbars.min.css';
	link.crossOrigin = 'anonymous';
	document.head.appendChild(link);
};

// 只在交互后加载Overlayscrollbars
let OverlayScrollbarsLoaded = false;
const loadOverlayScrollbars = async () => {
	if (!OverlayScrollbarsLoaded) {
		try {
			loadOverlayScrollbarsCSS();
			const { OverlayScrollbars } = await import('overlayscrollbars');
			OverlayScrollbarsLoaded = true;
			return OverlayScrollbars;
		} catch (error) {
			console.warn('Failed to load OverlayScrollbars:', error);
			return null;
		}
	}
	return null;
};

import {getStoredTheme, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_HOME,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT
} from "../constants/constants";
import { siteConfig } from '../config';

const bannerEnabled = !!document.getElementById('banner-wrapper');

// Set up click outside to close functionality for panels
// Optimized: Single event listener for all panels
// 只在桌面端使用复杂的面板交互，移动端简化
const isMobile = window.innerWidth <= 768;

// 简化的面板配置
const panelConfigs = {
	"display-setting": ["display-setting", "display-settings-switch"],
	"nav-menu-panel": ["nav-menu-panel", "nav-menu-switch"],
	"search-panel": ["search-panel", "search-bar", "search-switch"]
};

// 移动端优化：触摸事件处理
const mobileOptimizations = {
	init: () => {
		if (isMobile) {
			// 优化触摸事件
			document.addEventListener('touchstart', (e) => {
				// 防止双击缩放
				if (e.touches.length > 1) {
					e.preventDefault();
				}
			}, { passive: false });
			
			// 优化触摸滚动
			document.addEventListener('touchmove', (e) => {
				// 允许垂直滚动，防止水平滚动
				if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
					e.preventDefault();
				}
			}, { passive: false });
			
			// 优化点击事件
			mobileOptimizations.optimizeClickEvents();
			
			// 优化预加载策略
			mobileOptimizations.optimizePreloadStrategy();
		}
	},
	
	optimizeClickEvents: () => {
		// 移除300ms点击延迟
		const fastClick = (element, callback) => {
			let startTime = 0;
			
			element.addEventListener('touchstart', () => {
				startTime = Date.now();
			}, { passive: true });
			
			element.addEventListener('touchend', (e) => {
				const endTime = Date.now();
				if (endTime - startTime < 200) {
					e.preventDefault();
					callback(e);
				}
			}, { passive: false });
		};
		
		// 应用快速点击到非图片预览相关的链接，避免干扰 PhotoSwipe
		const links = Array.from(document.querySelectorAll('a'))
			.filter(link => 
				!link.closest('.gallery') && 
				!link.closest('.custom-md') &&
				!link.closest('#post-cover')
			);
		links.forEach(link => {
			fastClick(link, () => {
				link.click();
			});
		});
	},
	
	optimizePreloadStrategy: () => {
		// 移动端预加载策略
		if ('requestIdleCallback' in window) {
			requestIdleCallback(() => {
				// 移动端只预加载关键页面
				const criticalPages = [
					'/',
					'/archive'
				];
				
				criticalPages.forEach(link => {
					if (link !== window.location.pathname) {
						const prefetchLink = document.createElement('link');
						prefetchLink.rel = 'prefetch';
						prefetchLink.href = link;
						prefetchLink.as = 'document';
						prefetchLink.fetchPriority = 'low';
						document.head.appendChild(prefetchLink);
					}
				});
			});
		}
	}
};

// 初始化移动端优化
mobileOptimizations.init();

// Cache DOM elements for better performance
const cachedElements = {};

function getCachedElement(id) {
	if (!cachedElements[id]) {
		cachedElements[id] = document.getElementById(id);
	}
	return cachedElements[id];
}

// 只在桌面端添加复杂的点击事件处理
if (!isMobile) {
	document.addEventListener("click", (event) => {
		const target = event.target;
		if (!(target instanceof Node)) return;
		
		// Check all panels
		for (const [panelId, ignoreIds] of Object.entries(panelConfigs)) {
			const panel = getCachedElement(panelId);
			if (!panel) continue;
			
			// Check if click is inside any ignored elements
			let isInsideIgnored = false;
			for (const ignoreId of ignoreIds) {
				const ignoreElement = getCachedElement(ignoreId);
				if (ignoreElement && (ignoreElement === target || ignoreElement.contains(target))) {
					isInsideIgnored = true;
					break;
				}
			}
			
			// Check if click is inside the panel itself
			const isInsidePanel = panel.contains(target);
			
			// For nav-menu-panel, only close if clicked outside both the panel and the switch
			if (panelId === "nav-menu-panel") {
				if (!isInsideIgnored && !isInsidePanel) {
					panel.classList.add("float-panel-closed");
				}
			} else {
				// For other panels, keep existing behavior
				if (!isInsideIgnored) {
					panel.classList.add("float-panel-closed");
				}
			}
		}
	});
}

// Add click event listener for nav menu switch - Optimized with caching
const navMenuSwitch = getCachedElement("nav-menu-switch");
const navMenuPanel = getCachedElement("nav-menu-panel");

if (navMenuSwitch && navMenuPanel) {
    navMenuSwitch.addEventListener("click", (e) => {
        e.stopPropagation(); // Prevent immediate closing by click outside listener
        navMenuPanel.classList.toggle("float-panel-closed");
    }, { passive: true });
}

// Load theme from storage
function loadTheme() {
	const theme = getStoredTheme();
	setTheme(theme);
}

// Initialize custom scrollbar with lazy loading
// 只在桌面端初始化自定义滚动条，移动端使用原生滚动
async function initCustomScrollbar() {
	// 在移动端不使用自定义滚动条
	if (isMobile) return;
	
	const OverlayScrollbars = await loadOverlayScrollbars();
	if (!OverlayScrollbars) return;
	
	const bodyElement = document.querySelector('body');
	if (!bodyElement) return;
	
	// 优化滚动条配置
	OverlayScrollbars(
		{
			target: bodyElement,
			cancel: {
				nativeScrollbarsOverlaid: true,
				wheel: true,
				touch: true,
			}
		}, {
		scrollbars: {
			theme: 'scrollbar-base scrollbar-auto py-1',
			autoHide: 'move',
			autoHideDelay: 800,
			autoHideSuspend: true,
		},
		callbacks: {
			onInitialized: () => {
				// 滚动条初始化完成后执行
			},
			onDestroyed: () => {
				// 滚动条销毁时执行清理
			}
		}
	});
	
	// 优化：只在有元素时才初始化
	const preElements = document.querySelectorAll('pre');
	if (preElements.length > 0) {
		preElements.forEach((ele) => {
			OverlayScrollbars(ele, {
				scrollbars: {
					theme: 'scrollbar-base scrollbar-dark px-2',
					autoHide: 'leave',
					autoHideDelay: 500,
					autoHideSuspend: false
				}
			});
		});
	}
	
	// 优化：只在有元素时才初始化
	const katexElements = document.querySelectorAll('.katex-display');
	if (katexElements.length > 0) {
		katexElements.forEach((ele) => {
			OverlayScrollbars(ele, {
				scrollbars: {
					theme: 'scrollbar-base scrollbar-auto py-1',
				}
			});
		});
	}
}

// 添加滚动事件监听器，仅在用户滚动时初始化自定义滚动条
// 只在桌面端添加这些监听器
let customScrollbarInitialized = false;
function lazyInitCustomScrollbar() {
	if (!customScrollbarInitialized && !isMobile) {
		customScrollbarInitialized = true;
		initCustomScrollbar();
		// 移除事件监听器，避免重复初始化
		window.removeEventListener('scroll', lazyInitCustomScrollbar);
		window.removeEventListener('touchstart', lazyInitCustomScrollbar);
	}
}

// 监听滚动和触摸事件，触发懒加载
// 只在桌面端添加这些监听器
if (!isMobile) {
	window.addEventListener('scroll', lazyInitCustomScrollbar, { passive: true });
	window.addEventListener('touchstart', lazyInitCustomScrollbar, { passive: true });
}

// Show banner with animation
function showBanner() {
	if (!siteConfig.banner.enable) return;
	
	const banner = document.getElementById('banner');
	if (banner) {
		banner.classList.remove('opacity-0', 'scale-105');
	}
}

// Calculate banner height (already defined in inline script)

// Initialize on page load
function init() {
	loadTheme();
	showBanner();
	// 不再直接初始化自定义滚动条，改为懒加载
}

// Run initial setup
init();

// Set up Swup hooks
const setupSwupHooks = () => {
	// 性能监控
	const performanceMonitor = {
		measures: new Map(),
		start: (name) => {
			if ('performance' in window) {
				performance.mark(`${name}-start`);
			}
		},
		end: (name) => {
			if ('performance' in window) {
				performance.mark(`${name}-end`);
				try {
					performance.measure(name, `${name}-start`, `${name}-end`);
					const measure = performance.getEntriesByName(name)[0];
					if (measure) {
						performanceMonitor.measures.set(name, measure.duration);
					}
				} catch (e) {
					// 忽略性能API错误
				}
			}
		}
	};
	
	window.swup.hooks.on('link:click', () => {
		performanceMonitor.start('page-transition');
		
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms');

		// Prevent elements from overlapping the navbar during transition
		if (bannerEnabled) {
			const threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 72 - 16;
			const navbar = document.getElementById('navbar-wrapper');
			if (navbar && document.body.classList.contains('lg:is-home')) {
				if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
					navbar.classList.add('navbar-hidden');
				}
			}
		}
	});
	
	window.swup.hooks.on('content:replace', () => {
		// 优化资源清理
		cleanupResources();
		// 延迟初始化滚动条，避免阻塞页面过渡
		setTimeout(initCustomScrollbar, 50);
	});
	
	window.swup.hooks.on('visit:start', (visit) => {
		// Update body class for home page banner height
		const bodyElement = document.querySelector('body');
		if (bodyElement) {
			if (pathsEqual(visit.to.url, url('/'))) {
				bodyElement.classList.add('lg:is-home');
			} else {
				bodyElement.classList.remove('lg:is-home');
			}
		}

		// Increase page height during transition to prevent scrolling jump
		const heightExtend = document.getElementById('page-height-extend');
		if (heightExtend) {
			heightExtend.classList.remove('hidden');
		}
	});
	
	window.swup.hooks.on('visit:end', () => {
		performanceMonitor.end('page-transition');
		
		// Hide temp high element after transition
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend');
			if (heightExtend) {
				heightExtend.classList.add('hidden');
			}
			
			// 重置动画状态
			document.querySelectorAll('.onload-animation').forEach(el => {
				el.style.animation = 'none';
				el.offsetHeight; // 触发重排
				el.style.animation = '';
			});
			
			// 滚动到顶部，优化用户体验
			window.scrollTo({
				top: 0,
				behavior: 'smooth'
			});
			
			// 清理过期的性能指标
			cleanupPerformanceMarks();
		}, 100);
	});
	
	window.swup.hooks.on('animation:in:start', () => {
		// 禁用用户交互，避免过渡期间的意外操作
		document.body.style.pointerEvents = 'none';
	});
	
	window.swup.hooks.on('animation:in:end', () => {
		// 重新启用用户交互
		document.body.style.pointerEvents = 'auto';
	});
};

// 资源清理函数
function cleanupResources() {
	// 清理未使用的DOM元素
	const unusedElements = document.querySelectorAll('.temp-element, .lazy-loaded');
	unusedElements.forEach(el => {
		if (el.parentNode) {
			el.parentNode.removeChild(el);
		}
	});
	
	// 清理过期的prefetch链接
	const prefetchLinks = document.querySelectorAll('link[rel="prefetch"]');
	prefetchLinks.forEach(link => {
		if (link.dataset.expire && Date.now() > parseInt(link.dataset.expire)) {
			if (link.parentNode) {
				link.parentNode.removeChild(link);
			}
		}
	});
}

// 清理性能标记
function cleanupPerformanceMarks() {
	if ('performance' in window) {
		try {
			performance.getEntriesByType('mark').forEach(entry => {
				performance.clearMarks(entry.name);
			});
			performance.getEntriesByType('measure').forEach(entry => {
				performance.clearMeasures(entry.name);
			});
		} catch (e) {
			// 忽略性能API错误
		}
	}
}

// Initialize Swup hooks if available
if (window?.swup?.hooks) {
	setupSwupHooks();
} else if (window.swup) {
	// Fallback if hooks are not yet initialized
	document.addEventListener('swup:enable', setupSwupHooks);
}

// Initialize scroll elements
let backToTopBtn = document.getElementById('back-to-top-btn');
let navbar = document.getElementById('navbar-wrapper');

function refreshBackToTop() {
	backToTopBtn = document.getElementById('back-to-top-btn');
}

// Throttle scroll function to improve performance - 使用节流替代防抖，减少计算频率
let lastScrollTime = 0;
const SCROLL_THROTTLE_DELAY = isMobile ? 200 : 150; // 移动端增大节流延迟
let lastScrollPosition = 0;

function scrollFunction() {
	if (!backToTopBtn || !document.body.contains(backToTopBtn)) {
		refreshBackToTop();
	}
	const currentTime = Date.now();
	const currentScrollPosition = document.body.scrollTop || document.documentElement.scrollTop;
	
	// 节流：只在指定时间间隔后执行
	if (currentTime - lastScrollTime < SCROLL_THROTTLE_DELAY) {
		return;
	}
	
	// 避免重复计算：只有当滚动位置变化超过一定阈值时才执行
	if (Math.abs(currentScrollPosition - lastScrollPosition) < 10) {
		return;
	}
	
	lastScrollTime = currentTime;
	lastScrollPosition = currentScrollPosition;
	
	if (backToTopBtn) {
		backToTopBtn.classList.remove('hide');
	}

	// Update navbar visibility based on scroll position
	if (bannerEnabled && navbar) {
		const NAVBAR_HEIGHT = 72;
		const MAIN_PANEL_EXCESS_HEIGHT = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * 16;

		let currentBannerHeight = BANNER_HEIGHT;
		if (document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024) {
			currentBannerHeight = BANNER_HEIGHT_HOME;
		}
		
		const threshold = window.innerHeight * (currentBannerHeight / 100) - NAVBAR_HEIGHT - MAIN_PANEL_EXCESS_HEIGHT - 16;
		if (currentScrollPosition >= threshold) {
			navbar.classList.add('navbar-hidden');
		} else {
			navbar.classList.remove('navbar-hidden');
		}
	}
}

// Set up scroll and resize event listeners with passive option for better performance
window.addEventListener('scroll', scrollFunction, { passive: true });
document.addEventListener('DOMContentLoaded', () => {
	refreshBackToTop();
	scrollFunction();
});
window.addEventListener('load', () => {
	refreshBackToTop();
	scrollFunction();
}, { once: true });

// 移动端优化：触摸滚动事件
if (isMobile) {
	let touchScrollTimeout;
	
	window.addEventListener('touchmove', () => {
		// 防抖处理触摸滚动
		clearTimeout(touchScrollTimeout);
		touchScrollTimeout = setTimeout(() => {
			scrollFunction();
		}, SCROLL_THROTTLE_DELAY / 2);
	}, { passive: true });
}

// Throttle resize function to improve performance
let lastResizeTime = 0;
const RESIZE_THROTTLE_DELAY = isMobile ? 400 : 300; // 移动端增大resize节流延迟

function resizeFunction() {
	const currentTime = Date.now();
	if (currentTime - lastResizeTime < RESIZE_THROTTLE_DELAY) {
		return;
	}
	lastResizeTime = currentTime;
	
	// Recalculate banner height on resize
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
	
	// 移动端特殊处理
	if (isMobile) {
		// 重新计算移动端布局
		const bodyElement = document.querySelector('body');
		if (bodyElement) {
			// 调整移动端的banner高度
			if (bannerEnabled) {
				const mobileBannerHeight = Math.min(window.innerHeight * 0.4, 300);
				bodyElement.style.setProperty('--mobile-banner-height', `${mobileBannerHeight}px`);
			}
		}
	}
}

window.addEventListener('resize', resizeFunction, { passive: true });

// 移动端优化：设备旋转处理
if (isMobile) {
	window.addEventListener('orientationchange', () => {
		// 延迟执行，等待设备旋转完成
		setTimeout(resizeFunction, 100);
	}, { passive: true });
}

</script>

<script defer is:inline>
// Lazy load PhotoSwipe to improve initial page load performance
let lightbox = null;

// Initialize PhotoSwipe
async function initPhotoSwipe() {
	// Destroy existing instance if any
	if (lightbox) {
		lightbox.destroy();
		lightbox = null;
	}

	// Dynamically import PhotoSwipe Lightbox
	const PhotoSwipeLightbox = (await import("photoswipe/lightbox")).default;
	
	const options = {
		gallery: ".gallery a, .custom-md img, #post-cover img",
		pswpModule: () => import("photoswipe"),
		closeSVG: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round"><line x1="6" y1="6" x2="18" y2="18"></line><line x1="18" y1="6" x2="6" y2="18"></line></svg>',
		zoomSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M340-540h-40q-17 0-28.5-11.5T260-580q0-17 11.5-28.5T300-620h40v-40q0-17 11.5-28.5T380-700q17 0 28.5 11.5T420-660v40h40q17 0 28.5 11.5T500-580q0 17-11.5 28.5T460-540h-40v40q0 17-11.5 28.5T380-460q-17 0-28.5-11.5T340-500v-40Zm40 220q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l224 224q11 11 11 28t-11 28q-11 11-28 11t-28-11L532-372q-30 24-69 38t-83 14Zm0-80q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>',
		padding: { top: 20, bottom: 20, left: 20, right: 20 },
		wheelToZoom: true,
		arrowPrev: true,
		arrowNext: true,
		imageClickAction: 'zoom',
		bgClickAction: 'close',
		tapAction: 'toggle-controls',
		doubleTapAction: 'zoom',
	};

	lightbox = new PhotoSwipeLightbox(options);

	lightbox.addFilter("domItemData", (itemData, element) => {
		if (element instanceof HTMLImageElement) {
			itemData.src = element.src;
			itemData.w = Number(element.naturalWidth || window.innerWidth);
			itemData.h = Number(element.naturalHeight || window.innerHeight);
			itemData.msrc = element.src;
		}
		return itemData;
	});

	lightbox.init();
}

// Initialize PhotoSwipe when DOM is ready
document.addEventListener('DOMContentLoaded', initPhotoSwipe);

window.addEventListener('load', initPhotoSwipe, { once: true });

// Set up Swup hooks for PhotoSwipe if Swup is available (though currently disabled in astro.config)
const setupPhotoSwipe = () => {
	if (window.swup && window.swup.hooks) {
		window.swup.hooks.on("content:replace", () => {
			initPhotoSwipe();
		});
	}
};

if (window.swup) {
	setupPhotoSwipe();
} else {
	document.addEventListener("swup:enable", setupPhotoSwipe);
}
</script>

<style is:global>
.pswp__button--custom-x {
  font-size: 28px;
  line-height: 1;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  opacity: 0.9;
}
.pswp__button--custom-x:hover { opacity: 1; }
</style>
